name: Release (brew)

on:
  push:
    tags: ["v*"]
  workflow_dispatch:

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: Build and Test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-latest, ubuntu-latest]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Install dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: sudo apt-get update && sudo apt-get install -y clang
      - name: Install dependencies (macOS)
        if: matrix.os == 'macos-latest'
        run: brew install llvm || true
      - name: Cargo fmt
        run: cargo fmt -- --check
      - name: Build workspace (all targets)
        env:
          RUSTFLAGS: "-Dwarnings"
        run: cargo build --all --all-targets

  vscode:
    name: Build VS Code extension
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Set version info
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_ENV
      - name: Install and package extension
        working-directory: chic-vscode
        run: |
          set -euo pipefail
          npm ci
          npm run lint
          npm run package
          mv chic.vsix ../chic-vscode-${VERSION}.vsix
      - name: Upload extension artifact
        uses: actions/upload-artifact@v4
        with:
          name: vscode-extension
          path: chic-vscode-${{ env.VERSION }}.vsix
          if-no-files-found: error

  package:
    name: Build release artifacts
    needs: test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-latest, ubuntu-latest]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Install dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: sudo apt-get update && sudo apt-get install -y clang
      - name: Install dependencies (macOS)
        if: matrix.os == 'macos-latest'
        run: brew install llvm || true
      - name: Set version info
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_ENV
      - name: Build release binary
        run: cargo build --release --locked
      - name: Package artifact
        run: |
          set -euo pipefail
          ARCH="$(uname -m)"
          OS="$(echo "${RUNNER_OS}" | tr '[:upper:]' '[:lower:]')"
          ARTIFACT="chic-${VERSION}-${OS}-${ARCH}.tar.gz"
          mkdir -p dist/bin
          cp target/release/chic dist/bin/
          cp LICENSE README.md dist/
          tar -czf "$ARTIFACT" -C dist .
          shasum -a 256 "$ARTIFACT" > "$ARTIFACT.sha256"
          echo "ASSET_NAME=$ARTIFACT" >> $GITHUB_ENV
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.os }}
          path: |
            ${{ env.ASSET_NAME }}
            ${{ env.ASSET_NAME }}.sha256
          if-no-files-found: error

  stage-brew:
    name: Stage Homebrew release
    needs: [package, vscode]
    runs-on: ubuntu-latest
    steps:
      - name: Download release artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true
      - name: Set version info
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_ENV
      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          tag_name: ${{ github.ref_name }}
          name: chic ${{ env.VERSION }}
          files: |
            dist/*.tar.gz
            dist/*.tar.gz.sha256
            dist/*.vsix
      - name: Generate Homebrew formula (staged)
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          VERSION="${TAG#v}"
          REPO="${GITHUB_REPOSITORY}"
          MAC_TARBALL=$(ls dist/chic-${VERSION}-macos-*.tar.gz)
          LINUX_TARBALL=$(ls dist/chic-${VERSION}-linux-*.tar.gz)
          MAC_SHA=$(cut -d ' ' -f1 "${MAC_TARBALL}.sha256")
          LINUX_SHA=$(cut -d ' ' -f1 "${LINUX_TARBALL}.sha256")
          cat > chic.rb <<EOF
          class Chic < Formula
            desc "Temporary Rust-based compiler front-end and tooling for the Chic language."
            homepage "https://github.com/${REPO}"
            version "${VERSION}"

            on_macos do
              url "https://github.com/${REPO}/releases/download/${TAG}/$(basename "${MAC_TARBALL}")"
              sha256 "${MAC_SHA}"
            end

            on_linux do
              url "https://github.com/${REPO}/releases/download/${TAG}/$(basename "${LINUX_TARBALL}")"
              sha256 "${LINUX_SHA}"
            end

            def install
              bin.install "bin/chic"
              prefix.install "LICENSE"
              prefix.install "README.md"
            end

            test do
              system "#{bin}/chic", "--help"
            end
          end
          EOF
      - name: Upload staged Homebrew formula
        uses: actions/upload-artifact@v4
        with:
          name: homebrew-formula
          path: chic.rb

  tap-pr:
    name: Homebrew tap PR
    needs: stage-brew
    runs-on: ubuntu-latest
    steps:
      - name: Check tap secrets
        id: tap
        shell: bash
        run: |
          set -euo pipefail
          if [[ -z "${{ secrets.HOMEBREW_TAP }}" || -z "${{ secrets.HOMEBREW_TAP_TOKEN }}" ]]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi
      - name: Checkout tap
        if: steps.tap.outputs.skip != 'true'
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.HOMEBREW_TAP }}
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: tap
      - name: Download staged formula
        if: steps.tap.outputs.skip != 'true'
        uses: actions/download-artifact@v4
        with:
          name: homebrew-formula
          path: formula
      - name: Copy formula into tap
        if: steps.tap.outputs.skip != 'true'
        run: |
          set -euo pipefail
          mkdir -p tap/Formula
          cp formula/chic.rb tap/Formula/chic.rb
      - name: Open tap pull request
        if: steps.tap.outputs.skip != 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: tap
          add-paths: Formula/chic.rb
          commit-message: "chic ${GITHUB_REF_NAME}"
          branch: chic-release-${{ github.ref_name }}
          title: "chic ${GITHUB_REF_NAME}"
          body: |
            Automated update for chic ${GITHUB_REF_NAME}.
