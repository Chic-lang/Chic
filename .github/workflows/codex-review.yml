name: Codex Review

on:
  pull_request_target:
    types: [opened, reopened, synchronize, ready_for_review]

concurrency:
  group: codex-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  review:
    name: Codex review
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate PR diff
        run: |
          set -euo pipefail
          git fetch --no-tags origin "${{ github.event.pull_request.base.sha }}"
          git fetch --no-tags origin "${{ github.event.pull_request.head.sha }}"
          git diff "${{ github.event.pull_request.base.sha }}"..."${{ github.event.pull_request.head.sha }}" --unified=3 > pr.diff

      - name: Generate Codex review
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: ${{ vars.OPENAI_MODEL }}
        run: python3 .github/scripts/codex_review.py pr.diff > codex_review.json

      - name: Create inline PR review (once per commit)
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const payload = JSON.parse(fs.readFileSync('codex_review.json', 'utf8'));
            const marker = '<!-- codex-review-inline -->';
            const body = (payload.body || '').toString();
            const comments = Array.isArray(payload.comments) ? payload.comments : [];

            const { owner, repo } = context.repo;
            const pull_number = context.payload.pull_request.number;
            const commit_id = context.payload.pull_request.head.sha;

            const existingReviews = await github.paginate(
              github.rest.pulls.listReviews,
              { owner, repo, pull_number, per_page: 100 }
            );

            const alreadyReviewed = existingReviews.some(r =>
              r.user && r.user.login === 'github-actions[bot]' &&
              r.commit_id === commit_id &&
              (r.body || '').includes(marker)
            );

            if (alreadyReviewed) {
              core.info('Codex review already exists for this commit; skipping.');
              return;
            }

            await github.rest.pulls.createReview({
              owner,
              repo,
              pull_number,
              commit_id,
              event: 'COMMENT',
              body,
              comments
            });

      - name: Remove legacy Codex PR comment (if present)
        uses: actions/github-script@v7
        with:
          script: |
            const legacyMarker = '<!-- chic-codex-review -->';
            const { owner, repo } = context.repo;
            const issue_number = context.payload.pull_request.number;
            const comments = await github.paginate(github.rest.issues.listComments, { owner, repo, issue_number, per_page: 100 });
            const existing = comments.find(c => (c.body || '').includes(legacyMarker));
            if (!existing) return;
            await github.rest.issues.deleteComment({ owner, repo, comment_id: existing.id });
